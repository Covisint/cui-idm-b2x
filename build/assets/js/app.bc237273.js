!function(angular){"use strict";angular.module("app",["translate","ngMessages","cui.authorization","cui-ng","ui.router","snap","LocalStorageModule"]),angular.module("app").controller("myApplicationDetailsCtrl",["API","$scope","$stateParams","$state",function(API,$scope,$stateParams,$state){var myApplicationDetails=this,appId=$stateParams.appId,packageId=$stateParams.packageId,handleError=function(err){console.log("Error \n",err),$scope.$digest()},i=0,getDateGranted=function(creationUnixStamp){var dateGranted=new Date(creationUnixStamp),dateGrantedFormatted=dateGranted.getMonth()+"."+dateGranted.getDay()+"."+dateGranted.getFullYear();return dateGrantedFormatted},getBundledApps=function(service){myApplicationDetails.bundled=[],API.cui.getPackageServices({packageId:packageId}).then(function(res){i++,res.forEach(function(app){app.id!==myApplicationDetails.app.id&&(app.grantedDate=service.grantedDate,app.status=service.status,app.parentPackage=packageId,myApplicationDetails.bundled.push(app))}),2===i&&(myApplicationDetails.doneLoading=!0,$scope.$digest())}).fail(handleError)},checkIfAppIsGrantedToUser=function(app,pkgThatAppBelongsTo,packagesGrantedToUser){var pkgGrantThatMatches;return packagesGrantedToUser.some(function(pkg,i){return pkgThatAppBelongsTo.id===pkg.servicePackage.id?(pkgGrantThatMatches=packagesGrantedToUser[i],!0):!1}),pkgGrantThatMatches&&(app.status=pkgGrantThatMatches.status,app.grantedDate=getDateGranted(pkgGrantThatMatches.creation)),app.packageId=pkgThatAppBelongsTo.id,app},getRelatedApps=function(app){myApplicationDetails.related=[];var packagesGrantedToUser=[];API.cui.getPersonPackages({personId:API.getUser(),useCuid:!0}).then(function(res){return res.forEach(function(pkg){packagesGrantedToUser.push(pkg)}),API.cui.getPackages({qs:[["parentPackage.id",packageId]]})}).then(function(res){0===res.length&&(i++,2===i&&(myApplicationDetails.doneLoading=!0,$scope.$digest()));var packagesThatAreChildrenOfMainPacakge=res;packagesThatAreChildrenOfMainPacakge.forEach(function(pkg,z){API.cui.getServices({packageId:pkg.id}).then(function(res){res.forEach(function(app,z){app=checkIfAppIsGrantedToUser(app,pkg,packagesGrantedToUser),myApplicationDetails.related.push(app)}),z===packagesThatAreChildrenOfMainPacakge.length-1&&(i++,2===i&&(myApplicationDetails.doneLoading=!0,$scope.$digest()))}).fail(handleError)})}).fail(handleError)},getPackageGrantDetails=function(app){API.cui.getPersonPackage({personId:API.getUser(),useCuid:!0,packageId:packageId}).then(function(res){app.grantedDate=getDateGranted(res.creation),app.status=res.status,myApplicationDetails.app=app,getBundledApps(app),getRelatedApps(app)}).fail(handleError)};appId&&API.cui.getService({serviceId:appId}).then(function(res){var app=res;getPackageGrantDetails(app)}).fail(handleError),myApplicationDetails.goToDetails=function(application){$state.go("applications.myApplicationDetails",{packageId:application.parentPackage,appId:application.id})}}]),angular.module("app").controller("myApplicationsCtrl",["API","$scope","$state",function(API,$scope,$state){var myApplications=this;myApplications.list=[];var handleError=function(err){console.log("Error \n\n",err)},getApplicationsFromGrants=function(grants){var i=0;0===grants.length&&(myApplications.doneLoading=!0,$scope.$digest()),grants.forEach(function(grant){API.cui.getPackageServices({packageId:grant.servicePackage.id}).then(function(res){i++,res.forEach(function(service){service.status=grant.status,service.parentPackage=grant.servicePackage.id,myApplications.list.push(service)}),i===grants.length&&(myApplications.doneLoading=!0,$scope.$digest())}).fail(handleError)})};API.cui.getPersonPackages({personId:API.getUser(),useCuid:!0}).then(function(res){getApplicationsFromGrants(res)}).fail(handleError),myApplications.goToDetails=function(application){$state.go("applications.myApplicationDetails",{packageId:application.parentPackage,appId:application.id})}}]),angular.module("app").factory("AppRequests",["$filter",function($filter){var appRequestsObject={},appRequests={};return appRequests.set=function(newAppRequestsObject){appRequestsObject=newAppRequestsObject},appRequests.get=function(){return appRequestsObject},appRequests.buildReason=function(app,reason){var tempApp={};return angular.copy(app,tempApp),tempApp.reason=$filter("translate")("reason-im-requesting")+" "+$filter("cuiI18n")(tempApp.name)+": "+reason,tempApp},appRequests.getPackageRequests=function(userId,arrayOfAppsBeingRequested){var arrayOfPackagesBeingRequested=[],arrayOfPackageRequests=[];return arrayOfAppsBeingRequested.forEach(function(app,i){arrayOfPackagesBeingRequested.indexOf(app.packageId)>-1?arrayOfPackageRequests.some(function(packageRequest,i){return arrayOfPackageRequests[i].servicePackage.id===app.packageId?(arrayOfPackageRequests[i].reason=arrayOfPackageRequests[i].reason+("\n\n"+app.reason),!0):!1}):(arrayOfPackageRequests[i]={requestor:{id:userId,type:"person"},servicePackage:{id:arrayOfAppsBeingRequested[i].packageId,type:"servicePackage"},reason:app.reason},arrayOfPackagesBeingRequested[i]=app.packageId)}),arrayOfPackageRequests},appRequests}]),angular.module("app").controller("newAppRequestCtrl",["API","$scope","$state","AppRequests",function(API,$scope,$state,AppRequests){var newAppRequest=this,services=[],handleError=function(err){console.log("Error\n",err)},appsBeingRequested=AppRequests.get();newAppRequest.numberOfRequests=0,newAppRequest.appsBeingRequested=[],Object.keys(appsBeingRequested).forEach(function(appId){newAppRequest.numberOfRequests++,newAppRequest.appsBeingRequested.push(appsBeingRequested[appId])});var user,getListOfCategories=function(services){var categoryList=[];return services.forEach(function(service){if(service.category){var serviceCategoryInCategoryList=_.some(categoryList,function(category){return angular.equals(category,service.category)});serviceCategoryInCategoryList||categoryList.push(service.category)}}),categoryList};API.cui.getPerson({personId:API.getUser(),useCuid:!0}).then(function(res){return user=res,API.cui.getPackages()}).then(function(res){var i=0,packages=res;packages.forEach(function(pkg){API.cui.getPackageServices({packageId:pkg.id}).then(function(res){i++,res.forEach(function(service){services.push(service)}),i===packages.length&&(newAppRequest.categories=getListOfCategories(services),newAppRequest.loadingDone=!0,$scope.$digest())}).fail(handleError)})}).fail(handleError),newAppRequest.listenForEnter=function($event){13===$event.keyCode&&$state.go("applications.search",{name:newAppRequest.search})}}]),angular.module("app").controller("applicationReviewCtrl",["$scope","API","AppRequests",function($scope,API,AppRequests){var applicationReview=this,appRequests=AppRequests.get(),appsBeingRequested=Object.keys(appRequests),userId="IT88ZQJ8",handleError=function(err){console.log("Error \n",err)};applicationReview.appRequests=[];for(var i=0;i<appsBeingRequested.length;i+=2)applicationReview.appRequests.push([appRequests[appsBeingRequested[i]],appRequests[appsBeingRequested[i+1]]||void 0]);applicationReview.numberOfRequests=0,appsBeingRequested.forEach(function(){applicationReview.numberOfRequests++}),applicationReview.submit=function(){var applicationRequestArray=[];if(applicationReview.attempting=!0,applicationReview.appRequests.forEach(function(appRequestGroup,i){appRequestGroup.forEach(function(appRequest,x){appRequest&&(appRequest.reason&&""!==appRequest.reason?(appRequest.reasonRequired=!1,applicationReview.error=!1,applicationRequestArray[i+x]=AppRequests.buildReason(appRequest,appRequest.reason)):(appRequest.reasonRequired=!0,applicationReview.attempting=!1,applicationReview.error=!0))})}),!applicationReview.error){var appRequests=AppRequests.getPackageRequests(userId,applicationRequestArray),i=0;appRequests.forEach(function(appRequest){API.cui.createPackageRequest({data:appRequest}).then(function(res){i++,i===appRequests.length&&(applicationReview.attempting=!1,applicationReview.success=!0,$scope.$digest())}).fail(handleError)})}}}]),angular.module("app").controller("applicationSearchCtrl",["API","$scope","$stateParams","$state","$filter","AppRequests",function(API,$scope,$stateParams,$state,$filter,AppRequests){var userOrg,applicationSearch=this,userId="RN3BJI54",nameSearch=$stateParams.name,categorySearch=$stateParams.category,packageList=[],userPackageList=[],handleError=function(err){console.log("Error \n",err)};applicationSearch.nameSearch=nameSearch,applicationSearch.category=categorySearch;var user,nameFilter=function(app,search){return search&&""!==search?$filter("cuiI18n")(app.name).toLowerCase().indexOf(search.toLowerCase())>-1:!0},categoryFilter=function(app,category){return!app.category&&category?!1:category?$filter("cuiI18n")(app.category).indexOf(category)>-1:!0};applicationSearch.parseAppsByCategoryAndName=function(){var filteredApps=_.filter(applicationSearch.unparsedListOfAvailabeApps,function(app){return nameFilter(app,applicationSearch.nameSearch)&&categoryFilter(app,applicationSearch.category)});applicationSearch.list=filteredApps,applicationSearch.doneLoading=!0};var getApplications=function(packageListPassed,packagesTheOrgHasGrants){var listOfAvailabeApps=[],i=0,listOfPackages=packageListPassed||packageList;listOfPackages.forEach(function(pkg){pkg.requestable?API.cui.getPackageServices({packageId:pkg.id}).then(function(res){i++,res.forEach(function(service){packagesTheOrgHasGrants.indexOf(pkg.id)>-1&&(service.orgHasGrants=!0),service.packageId=pkg.id,listOfAvailabeApps.push(service)}),i===listOfPackages.length&&(applicationSearch.unparsedListOfAvailabeApps=listOfAvailabeApps,applicationSearch.parseAppsByCategoryAndName(),$scope.$digest())}).fail(handleError):i++,i===listOfPackages.length&&(applicationSearch.unparsedListOfAvailabeApps=listOfAvailabeApps,applicationSearch.parseAppsByCategoryAndName(),$scope.$digest())})},getAvailableApplications=function(userPackageGrantList){packageList.forEach(function(pkg,i){var userGrantInPackageList=_.some(userPackageList,function(userPackageGrant){return pkg.id===userPackageGrant.servicePackage.id});userGrantInPackageList&&packageList.splice(i,1)}),API.cui.getOrganizationPackages({organizationId:userOrg}).then(function(res){var packagesTheOrgHasGrants=[];res.forEach(function(pkgGrant){packagesTheOrgHasGrants.push(pkgGrant.servicePackage.id)}),getApplications(packageList,packagesTheOrgHasGrants)}).fail(handleError)},getUserPackageGrants=function(){API.cui.getPersonPackages({personId:userId}).then(function(res){userPackageList=res,getAvailableApplications(userPackageList)}).fail(handleError)};API.cui.getPerson({personId:userId}).then(function(res){return userOrg=res.organization.id,user=res,API.cui.getPackages()}).then(function(res){var packages=res;packages.forEach(function(pkg){packageList.push(pkg)}),getUserPackageGrants()}).fail(handleError),applicationSearch.listenForEnter=function($event){13===$event.keyCode&&applicationSearch.parseAppsByCategoryAndName()},applicationSearch.numberOfRequests=0;var processNumberOfRequiredApps=function(pkgRequest){pkgRequest?applicationSearch.numberOfRequests++:applicationSearch.numberOfRequests--};applicationSearch.packageRequests=AppRequests.get(),applicationSearch.appCheckbox={},Object.keys(applicationSearch.packageRequests).forEach(function(appId){applicationSearch.appCheckbox[appId]=!0,applicationSearch.numberOfRequests++}),applicationSearch.toggleRequest=function(application){applicationSearch.packageRequests[application.id]?delete applicationSearch.packageRequests[application.id]:applicationSearch.packageRequests[application.id]=application,processNumberOfRequiredApps(applicationSearch.packageRequests[application.id])};var bundled=[],related=[],detailsFetchStep=0,getBundledApps=function($index,application){bundled[$index]=[],API.cui.getPackageServices({packageId:application.packageId}).then(function(res){res.forEach(function(app){app.id!==application.id&&(app.packageId=application.packageId,bundled[$index].push(app))}),detailsFetchStep++,2===detailsFetchStep&&(applicationSearch.list[$index].details={bundled:bundled[$index],related:related[$index]},applicationSearch.detailsLoadingDone[application.id]=!0,$scope.$digest())}).fail(handleError)},getRelatedAppsThatHaventBeenGranted=function(packagesToIgnore,packages,$index,application){var z=0;packages.forEach(function(pkg){-1===packagesToIgnore.indexOf(pkg.id)?API.cui.getPackageServices({packageId:pkg.id}).then(function(res){z++,res.forEach(function(app){app.packageId=pkg.id,related[$index].push(app)}),z===packages.length&&(detailsFetchStep++,2===detailsFetchStep&&(applicationSearch.list[$index].details={bundled:bundled[$index],related:related[$index]},applicationSearch.detailsLoadingDone[application.id]=!0,$scope.$digest()))}).fail(handleError):(z++,z===packages.length&&(detailsFetchStep++,2===detailsFetchStep&&(applicationSearch.list[$index].details={bundled:bundled[$index],related:related[$index]},applicationSearch.detailsLoadingDone[$index]=!0,$scope.$digest())))})},getRelatedApps=function($index,application){related[$index]=[],API.cui.getPackages({qs:[["parentPackage.id",application.packageId]]}).then(function(res){0===res.length&&(detailsFetchStep++,2===detailsFetchStep&&(applicationSearch.list[$index].details={bundled:bundled[$index],related:related[$index]},applicationSearch.detailsLoadingDone[application.id]=!0,$scope.$digest()));var packages=res,packagesToIgnore=[];API.cui.getPersonPackages({personId:userId}).then(function(res){res.forEach(function(pkgGrant,i){_.some(packages,function(pkg){return pkg.id===pkgGrant.servicePackage.id})&&packagesToIgnore.push(pkgGrant.servicePackage.id)}),getRelatedAppsThatHaventBeenGranted(packagesToIgnore,packages,$index,application)}).fail(handleError)}).fail(handleError)};applicationSearch.detailsLoadingDone={},applicationSearch.getRelatedAndBundled=function($index,application){applicationSearch.detailsLoadingDone[application.id]||(detailsFetchStep=0,getBundledApps($index,application),getRelatedApps($index,application))},applicationSearch.saveRequestsAndCheckout=function(){AppRequests.set(applicationSearch.packageRequests),$state.go("applications.reviewRequest")}}]),angular.module("app").controller("baseCtrl",["$state","GetCountries","GetTimezones","$scope","$translate","LocaleService","User","API","Menu",function($state,GetCountries,GetTimezones,$scope,$translate,LocaleService,User,API,Menu){var base=this;base.goBack=function(){""!==$state.previous.name.name?$state.go($state.previous.name,$state.previous.params):$state.go("base")},base.generateHiddenPassword=function(password){return Array(password.length+1).join("•")},base.menu=Menu,console.log(base.menu),base.passwordPolicies=[{allowUpperChars:!0,allowLowerChars:!0,allowNumChars:!0,allowSpecialChars:!0,requiredNumberOfCharClasses:3},{disallowedChars:"^&*)(#$"},{min:8,max:18},{disallowedWords:["password","admin"]}],base.getLanguageCode=function(){return LocaleService.getLocaleCode().indexOf("_")>-1?LocaleService.getLocaleCode().split("_")[0]:LocaleService.getLocaleCode()};var setCountries=function(language){language=language||"en",language.indexOf("_")>-1&&(language=language.split("_")[0]),GetCountries(language).then(function(res){base.countries=res.data})["catch"](function(err){console.log(err)})},setTimezones=function(language){language=language||"en",language.indexOf("_")>-1&&(language=language.split("_")[0]),GetTimezones(language).then(function(res){base.timezones=res.data})["catch"](function(err){console.log(err)})};$scope.$on("languageChange",function(e,args){setCountries(args),setTimezones(args)}),API.handleCovAuthResponse().then(function(res){return console.log("TEST!!!"),API.setUser(res),API.cui.getPersonRoles({personId:API.getUser()})}).then(function(roles){console.log("ROLES",roles);var roleList=[];roles.forEach(function(role){roleList.push(role.name)}),API.setUserEntitlements(roleList)}),base.userEntitlements=[],$scope.$on("newEntitlements",function(newEntitlements){base.userEntitlements=newEntitlements}),setCountries($translate.proposedLanguage()),setTimezones($translate.proposedLanguage())}]),angular.module("app").config(["$translateProvider","$locationProvider","$stateProvider","$urlRouterProvider","$injector","localStorageServiceProvider","$cuiIconProvider","$cuiI18nProvider",function($translateProvider,$locationProvider,$stateProvider,$urlRouterProvider,$injector,localStorageServiceProvider,$cuiIconProvider,$cuiI18nProvider){localStorageServiceProvider.setPrefix("cui");var templateBase="assets/app/",returnCtrlAs=function(name,asPrefix){return name+"Ctrl as "+(asPrefix?asPrefix:"")+(asPrefix?name[0].toUpperCase()+name.slice(1,name.length):name)};$stateProvider.state("base",{url:"/",templateUrl:templateBase+"base/base.html",controller:returnCtrlAs("base")}).state("users",{url:"/users",templateUrl:templateBase+"misc/users/users.html"}).state("users.search",{url:"/",templateUrl:templateBase+"misc/users/search/users.search.html",controller:returnCtrlAs("usersSearch")}).state("users.invitations",{url:"/invitations",templateUrl:templateBase+"misc/invitations/search/users.invitations.search.html",controller:returnCtrlAs("usersInvitations")}).state("users.invite",{url:"/invite",templateUrl:templateBase+"misc/invitations/invite/users.invite.html",controller:returnCtrlAs("usersInvite")}).state("users.activate",{url:"/activate/:id",templateUrl:templateBase+"users/users.activate/users.activate.html",controller:returnCtrlAs("usersActivate")}).state("registration",{url:"/register",templateUrl:templateBase+"registration/registration.html"}).state("registration.invited",{url:"/invitation?id&code",templateUrl:templateBase+"registration/userInvited/users.register.html",controller:returnCtrlAs("usersRegister")}).state("registration.walkup",{url:"/walkup",templateUrl:templateBase+"registration/userWalkup/users.walkup.html",controller:returnCtrlAs("usersWalkup"),menu:{desktop:!1}}).state("registration.tlo",{url:"/top-level-org",templateUrl:templateBase+"registration/newTopLevelOrg/topLevelOrg.registration.html",controller:returnCtrlAs("tlo","new")}).state("registration.division",{url:"/new-division",templateUrl:templateBase+"registration/newDivision/division.registration.html",controller:returnCtrlAs("division","new")}).state("applications",{url:"/applications",templateUrl:templateBase+"applications/applications.html"}).state("applications.myApplications",{url:"/",templateUrl:templateBase+"applications/my-applications/my-applications.html",controller:returnCtrlAs("myApplications")}).state("applications.myApplicationDetails",{url:"/:packageId/:appId",templateUrl:templateBase+"applications/my-applications/my-application-details.html",controller:returnCtrlAs("myApplicationDetails")}).state("applications.newRequest",{url:"/request",templateUrl:templateBase+"applications/new-request&review/new-request.html",controller:returnCtrlAs("newAppRequest")}).state("applications.search",{url:"/search?name&category&page",templateUrl:templateBase+"applications/search/search.html",controller:returnCtrlAs("applicationSearch")}).state("applications.reviewRequest",{url:"/review",templateUrl:templateBase+"applications/new-request&review/review.html",controller:returnCtrlAs("applicationReview")}).state("welcome",{url:"/welcome",templateUrl:templateBase+"misc/welcome/welcome.html"}).state("welcome.screen",{url:"/welcome",templateUrl:templateBase+"misc/welcome/welcome.screen.html",controller:returnCtrlAs("welcome")}).state("misc",{url:"/status",templateUrl:templateBase+"misc/misc.html"}).state("misc.404",{url:"/404",templateUrl:templateBase+"misc/misc.404.html"}).state("misc.notAuth",{url:"/notAuthorized",templateUrl:templateBase+"misc/misc.notAuth.html"}).state("misc.pendingStatus",{url:"/pendingStatus",templateUrl:templateBase+"misc/misc.pendingStatus.html"}).state("misc.success",{url:"/success",templateUrl:templateBase+"misc/misc.success.html"}).state("profile",{url:"/profile",templateUrl:templateBase+"profile/profile.html"}).state("profile.user",{url:"/user:id",templateUrl:templateBase+"profile/user/users.edit.html",controller:returnCtrlAs("usersEdit")}).state("profile.organization",{url:"/organization",templateUrl:templateBase+"profile/organization/organization.profile.html",controller:returnCtrlAs("orgProfile")}).state("empty",{url:"/empty",templateUrl:templateBase+"empty/empty.html",controller:returnCtrlAs("empty")}),$urlRouterProvider.otherwise(function($injector){var $state=$injector.get("$state");$state.go("base")}),$cuiI18nProvider.setLocaleCodesAndNames({en:"English",pt:"Portuguese",tr:"Turkish",zh:"Chinese (Simplified)",fr:"French",es:"Spanish",it:"Italian",ru:"Russian",th:"Thai",ja:"Japanese",de:"German"});var languageKeys=Object.keys($cuiI18nProvider.getLocaleCodesAndNames()),returnRegisterAvailableLanguageKeys=function(){var object={"*":languageKeys[0]};return languageKeys.forEach(function(languageKey){object[languageKey+"*"]=languageKey}),object};$translateProvider.useLoader("LocaleLoader",{url:"bower_components/cui-i18n/dist/cui-i18n/angular-translate/",prefix:"locale-",suffix:".json"}).registerAvailableLanguageKeys(languageKeys,returnRegisterAvailableLanguageKeys()).uniformLanguageTag("java").determinePreferredLanguage().fallbackLanguage(languageKeys),$cuiI18nProvider.setLocalePreference(languageKeys),$cuiIconProvider.iconSet("cui","bower_components/cui-icons/dist/icons/icons-out.svg",48,!0),$cuiIconProvider.iconSet("fa","bower_components/cui-icons/dist/font-awesome/font-awesome-out.svg",216,!0)}]),angular.module("app").run(["LocaleService","$rootScope","$state","$http","$templateCache","$cuiI18n","User","cui.authorization.routing","Menu",function(LocaleService,$rootScope,$state,$http,$templateCache,$cuiI18n,User,routing,Menu){var languageNameObject=$cuiI18n.getLocaleCodesAndNames();for(var LanguageKey in languageNameObject)LocaleService.setLocales(LanguageKey,languageNameObject[LanguageKey]);$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){routing($rootScope,$state,toState,toParams,fromState,fromParams,User.getEntitlements()),toState.menu?(angular.isDefined(toState.menu.desktop)&&toState.menu.desktop===!1?Menu.desktop.hide():Menu.desktop.show(),angular.isDefined(toState.menu.mobile)&&toState.menu.mobile===!1?Menu.mobile.hide():Menu.mobile.show()):(Menu.desktop.show(),Menu.mobile.show())}),$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){$state.previous={},$state.previous.name=fromState,$state.previous.params=fromParams});var icons=["bower_components/cui-icons/dist/icons/icons-out.svg","bower_components/cui-icons/dist/font-awesome/font-awesome-out.svg"];angular.forEach(icons,function(icon){$http.get(icon,{cache:$templateCache})})}]),angular.module("app").controller("emptyCtrl",["$scope","API","$window","$state",function($scope,API,$window,$state){console.log("IM IN EMPTY CTR"),$state.go("applications.myApplications")}]),angular.module("app").factory("API",["$state","User","$rootScope",function($state,User,$rootScope){function jwtAuthHandler(){return myCUI.covAuth({originUri:originUri,authRedirect:window.location.href.split("#")[0]+"#/empty",appRedirect:window.location.href})}var myCUI=cui.api();cui.log("cui.js v",myCUI.version()),myCUI.setServiceUrl("STG");var originUri="coke-idm.run.covapp.io";return myCUI.setAuthHandler(jwtAuthHandler),{cui:myCUI,getUser:User.get,setUser:User.set,getUserEntitlements:User.getEntitlements,setUserEntitlements:User.setEntitlements,handleCovAuthResponse:myCUI.handleCovAuthResponse}}]),angular.module("app").factory("GetCountries",["$http",function($http){return function(locale){return $http.get("bower_components/cui-i18n/dist/cui-i18n/angular-translate/countries/"+locale+".json")}}]),angular.module("app").factory("GetTimezones",["$http",function($http){return function(locale){return $http.get("bower_components/cui-i18n/dist/cui-i18n/angular-translate/timezones/"+locale+".json")}}]),angular.module("app").factory("Menu",["$rootScope",function($rootScope){return{desktop:{state:"open",enabled:!0,open:function(){this.state="open"},close:function(){this.state="closed"},toggle:function(){"open"===this.state?this.state="closed":this.state="open"},hide:function(){this.enabled=!1},show:function(){this.enabled=!0}},mobile:{state:"closed",enabled:!0,open:function(){this.state="open"},close:function(){this.state="close"},toggle:function(){"open"===this.state?this.state="closed":this.state="open"},hide:function(){this.enabled=!1},show:function(){this.state=!0}}}}]),angular.module("app").factory("User",["$rootScope",function($rootScope){var user={entitlements:[]};return{set:function(newUser){user.cuid=newUser.cuid},get:function(){return user.cuid||"[cuid]"},setEntitlements:function(newEntitlements){user.entitlements=newEntitlements,$rootScope.$broadcast("newEntitlements",user.entitlements)},getEntitlements:function(){return console.log("getting entitlements:",user.entitlements),user.entitlements}}}]),angular.module("app").controller("usersInviteCtrl",["localStorageService","$scope","$stateParams","API",function(localStorageService,$scope,$stateParams,API){var usersInvite=this;usersInvite.user={},usersInvite.user.organization={id:"OCOVSMKT-CVDEV204002",type:"organization",realm:"APPCLOUD"};var sendInvitationEmail=function(invitation){var message="You've received an invitation to join our organization.<p><a href='localhost:9001/#/users/register?id="+invitation.id+"&code="+invitation.invitationCode+"'>Click here to register</a>.";console.log(message),usersInvite.sending=!1,usersInvite.sent=!0,$scope.$digest()};usersInvite.saveUser=function(form){angular.forEach(form.$error,function(field){angular.forEach(field,function(errorField){errorField.$setTouched()})}),form.$valid&&(usersInvite.sending=!0,usersInvite.sent=!1,usersInvite.fail=!1,usersInvite.user.timezone="EST5EDT",usersInvite.user.language=$scope.$parent.base.getLanguageCode(),API.cui.createPerson({data:usersInvite.user}).then(function(res){return API.cui.createPersonInvitation({data:build.personInvitation(res)})}).then(function(res){sendInvitationEmail(res)}).fail(function(err){usersInvite.sending=!1,usersInvite.fail=!0,$scope.$digest()}))};var build={personInvitation:function(invitee){return{email:invitee.email,invitor:{id:"RN3BJI54",type:"person"},invitee:{id:invitee.id,type:"person"},targetOrganization:{id:"OCOVSMKT-CVDEV204002",type:"organization"}}}}}]),angular.module("app").controller("usersInvitationsCtrl",["localStorageService","$scope","$stateParams","API","$timeout",function(localStorageService,$scope,$stateParams,API,$timeout){var usersInvitations=this;usersInvitations.listLoading=!0,usersInvitations.invitor=[],usersInvitations.invitee=[],usersInvitations.invitorLoading=[],usersInvitations.inviteeLoading=[],API.cui.getPersonInvitations().then(function(res){usersInvitations.listLoading=!1,usersInvitations.list=res,$scope.$apply()}).fail(function(err){usersInvitations.listLoading=!1,console.log(err)}),usersInvitations.getInfo=function(invitorId,inviteeId,index){void 0===usersInvitations.invitor[index]&&(usersInvitations.invitorLoading[index]=!0,usersInvitations.inviteeLoading[index]=!0,API.cui.getPerson({personId:invitorId}).then(function(res){usersInvitations.invitor[index]=res,$scope.$apply(),$timeout(function(){usersInvitations.invitorLoading[index]=!1},500)}).fail(function(err){console.log(err)}),API.cui.getPerson({personId:inviteeId}).then(function(res){usersInvitations.invitee[index]=res,$scope.$apply(),$timeout(function(){usersInvitations.inviteeLoading[index]=!1},500)}).fail(function(err){console.log(err)}))}}]),angular.module("app").factory("Person",["$http","$q","API",function($http,$q,API){var getById=function(id){return $http({method:"GET",url:API.cui.getServiceUrl()+"/person/v1/persons/"+id,headers:{Accept:"application/vnd.com.covisint.platform.person.v1+json",Authorization:"Bearer "+API.token()}}).then(function(res){return res})["catch"](function(res){return $q.reject(res)})},getInvitations=function(){return $http({method:"GET",url:API.cui.getServiceUrl()+"/person/v1/personInvitations/",headers:{Accept:"application/vnd.com.covisint.platform.person.invitation.v1+json",Authorization:"Bearer "+API.token()}}).then(function(res){return res})["catch"](function(res){return $q.reject(res)})},getInvitationById=function(id){return $http({method:"GET",url:API.cui.getServiceUrl()+"/person/v1/personInvitations/"+id,headers:{Accept:"application/vnd.com.covisint.platform.person.invitation.v1+json",Authorization:"Bearer "+API.token()}}).then(function(res){return res})["catch"](function(res){return $q.reject(res)})},createInvitation=function(invitee,invitor){return $http({method:"POST",url:API.cui.getServiceUrl()+"/person/v1/personInvitations",headers:{Accept:"application/vnd.com.covisint.platform.person.invitation.v1+json",Authorization:"Bearer "+API.token(),"Content-type":"application/vnd.com.covisint.platform.person.invitation.v1+json"},data:{email:invitee.email,invitor:{id:invitor.id,type:"person"},invitee:{id:invitee.id,type:"person"},targetOrganization:{id:"OCOVSMKT-CVDEV204002",type:"organization"}}}).then(function(res){return res})["catch"](function(res){return $q.reject(res)})},update=function(id,data){return $http({method:"PUT",url:API.cui.getServiceUrl()+"/person/v1/persons/"+id,headers:{Accept:"application/vnd.com.covisint.platform.person.v1+json",Authorization:"Bearer "+API.token(),"Content-Type":"application/vnd.com.covisint.platform.person.v1+json"},data:data}).then(function(res){return res})["catch"](function(res){return $q.reject(res)})},create=function(data){return $http({method:"POST",url:API.cui.getServiceUrl()+"/person/v1/persons",headers:{Accept:"application/vnd.com.covisint.platform.person.v1+json",Authorization:"Bearer "+API.token(),"Content-Type":"application/vnd.com.covisint.platform.person.v1+json"},data:data}).then(function(res){return res})["catch"](function(res){return $q.reject(res)})},sendUserInvitationEmail=function(body){return $http({method:"POST",url:"http://localhost:8000/invitation/person","Content-Type":"application/json",data:body}).then(function(res){return res})["catch"](function(err){return $q.reject(err)})},getSecurityQuestions=function(){return $http({method:"GET",url:API.cui.getServiceUrl()+"/authn/v2/securityQuestions",headers:{Accept:"application/vnd.com.covisint.platform.securityquestion.v1+json",Authorization:"Bearer "+API.token()}}).then(function(res){return res})["catch"](function(err){return $q.reject(err)})},getPasswordAccount=function(id){return $http({method:"GET",url:API.cui.getServiceUrl()+"/person/v1/persons/"+id+"/accounts/password",headers:{Accept:"application/vnd.com.covisint.platform.person.account.password.v1+json",Authorization:"Bearer "+API.token()}}).then(function(res){return res})["catch"](function(err){return $q.reject(err)})},createPasswordAccount=function(id,data){return $http({method:"PUT",url:API.cui.getServiceUrl()+"/person/v1/persons/"+id+"/accounts/password",headers:{Accept:"application/vnd.com.covisint.platform.person.account.password.v1+json",Authorization:"Bearer "+API.token(),"Content-Type":"application/vnd.com.covisint.platform.person.account.password.v1+json"},data:data}).then(function(res){return res})["catch"](function(err){return $q.reject(err)})},createSecurityQuestions=function(id,data){return $http({method:"PUT",url:API.cui.getServiceUrl()+"/authn/v2/persons/"+id+"/accounts/securityQuestion",headers:{Accept:"application/vnd.com.covisint.platform.person.account.securityQuestion.v1+json",Authorization:"Bearer "+API.token(),"Content-Type":"application/vnd.com.covisint.platform.person.account.securityQuestion.v1+json"},data:data}).then(function(res){return res})["catch"](function(err){return $q.reject(err)})},grantExchangePackage=function(id){return $http({method:"PUT",url:API.cui.getServiceUrl()+"/service/v1/persons/"+id+"/packages/PCOVSMKT-CVDEV204003000",headers:{Accept:"application/vnd.com.covisint.platform.package.grant.v1+json",Authorization:"Bearer "+API.token(),"Content-Type":"application/vnd.com.covisint.platform.package.grant.v1+json"
},data:{version:1,grantee:{id:id,type:"person"},servicePackage:{id:"PCOVSMKT-CVDEV204003000"}}}).then(function(res){return res})["catch"](function(err){return $q.reject(err)})},grantCcaPackage=function(id){return $http({method:"PUT",url:API.cui.getServiceUrl()+"/service/v1/persons/"+id+"/packages/PAPC2040605",headers:{Accept:"application/vnd.com.covisint.platform.package.grant.v1+json",Authorization:"Bearer "+API.token(),"Content-Type":"application/vnd.com.covisint.platform.package.grant.v1+json"},data:{version:1,grantee:{id:id,type:"person"},servicePackage:{id:"PAPC2040605"}}}).then(function(res){return res})["catch"](function(err){return $q.reject(err)})},person={getAll:API.cui.getUsers,getById:getById,update:update,getInvitations:getInvitations,create:create,createInvitation:createInvitation,sendUserInvitationEmail:sendUserInvitationEmail,getInvitationById:getInvitationById,getSecurityQuestions:getSecurityQuestions,getPasswordAccount:getPasswordAccount,createPasswordAccount:createPasswordAccount,createSecurityQuestions:createSecurityQuestions,grantCcaPackage:grantCcaPackage,grantExchangePackage:grantExchangePackage};return person}]),angular.module("app").controller("usersActivateCtrl",["$stateParams","API","Person",function($stateParams,API,Person){var personParams=[{name:"personId",value:$stateParams.id}];API.cui.activatePerson({params:personParams}).then(function(res){return Person.grantCcaPackage($stateParams.id)}).then(function(res){return Person.grantExchangePackage($stateParams.id)}).then(function(res){console.log(res)}).fail(function(err){console.log(err)})}]),angular.module("app").controller("usersSearchCtrl",["localStorageService","$scope","API","Person",function(localStorageService,$scope,API,Person){var usersSearch=this;usersSearch.listLoading=!0,API.cui.getPersons().then(function(res){usersSearch.listLoading=!1,usersSearch.list=res,usersSearch.list.splice(0,4),$scope.$apply()}).fail(function(err){usersSearch.listLoading=!1});var search=function(){usersSearch.search&&(console.log(usersSearch.search),API.cui.getPersons({data:usersSearch.search}).then(function(res){usersSearch.list=res,$scope.$apply()}).fail(function(err){}))};$scope.$watchCollection("usersSearch.search",search)}]),angular.module("app").controller("welcomeCtrl",["$scope",function($scope){}]),angular.module("app").controller("orgProfileCtrl",["$scope","$stateParams","API",function($scope,$stateParams,API){var orgProfile=this;orgProfile.organization={},API.cui.getPerson({personId:API.getUser(),useCuid:!0}).then(function(res){return API.cui.getOrganization({organizationId:res.organization.id})}).then(function(res){orgProfile.organization=res,orgProfile.loadingDone=!0,$scope.$digest()}).fail(function(err){console.log(err)})}]),angular.module("app").controller("usersEditCtrl",["$scope","$timeout","API",function($scope,$timeout,API){var currentCountry,usersEdit=this;usersEdit.loading=!0,usersEdit.timezones=$scope.$parent.base.timezones,usersEdit.tempLanguages=["en","zh"],usersEdit.updatePerson=function(){usersEdit.loading=!0,usersEdit.userCountry?usersEdit.tempUser.addresses[0].country=usersEdit.userCountry.description.code:usersEdit.tempUser.addresses[0].country=usersEdit.user.addresses[0].country,angular.copy(usersEdit.tempUser,usersEdit.user),API.cui.updatePerson({personId:API.getUser(),useCuid:!0,data:usersEdit.user}).then(function(){usersEdit.loading=!1,$scope.$digest()}).fail(function(error){console.log(error),usersEdit.loading=!1})},usersEdit.resetEdit=function(master,temp){angular.copy(master,temp)},usersEdit.checkIfFieldsAreEmpty=function(field){return""===field?usersEdit.emptyFieldError=!0:usersEdit.emptyFieldError=!1,usersEdit.emptyFieldError},usersEdit.updatePersonSecurityAccount=function(){};var selectQuestionsForUser=function(){usersEdit.challengeQuestion1={},usersEdit.challengeQuestion1={};var questions=[];angular.forEach(usersEdit.userSecurityQuestions.questions,function(userQuestion){var question=_.find(usersEdit.allSecurityQuestions,function(question){return question.id===userQuestion.question.id});this.push(question)},questions),console.log("questions",questions),usersEdit.challengeQuestion1=questions[0],usersEdit.challengeQuestion1.answer="",usersEdit.challengeQuestion2=questions[1],usersEdit.challengeQuestion2.answer="",$scope.$digest()};API.cui.getPerson({personId:API.getUser(),useCuid:!0}).then(function(res){return res.addresses||(res.addresses=[{}],res.addresses[0].streets=[[]]),usersEdit.user=angular.copy(res),usersEdit.tempUser=angular.copy(res),currentCountry=res.addresses[0].country,API.cui.getSecurityQuestionAccount({personId:API.getUser(),useCuid:!0})}).then(function(res){return usersEdit.userSecurityQuestions=res,usersEdit.tempUserSecurityQuestions=res,API.cui.getSecurityQuestions()}).then(function(res){return usersEdit.allSecurityQuestions=res,selectQuestionsForUser(),API.cui.getPersonPassword({personId:API.getUser(),useCuid:!0})}).then(function(res){usersEdit.userPassword=res,usersEdit.tempUserPasswordAccount=res,usersEdit.loading=!1,$scope.$digest()}).fail(function(err){console.log(err),usersEdit.loading=!1,$scope.$digest()}),usersEdit.saveChallengeQuestions=function(){var updatedChallengeQuestions={};updatedChallengeQuestions=[{question:{text:usersEdit.challengeQuestion1.question[0].text,lang:usersEdit.challengeQuestion1.question[0].lang,answer:usersEdit.challengeAnswer1,index:1},owner:{id:usersEdit.challengeQuestion1.owner.id}},{question:{text:usersEdit.challengeQuestion2.question[0].text,lang:usersEdit.challengeQuestion2.question[0].lang,answer:usersEdit.challengeAnswer2,index:2},owner:{id:usersEdit.challengeQuestion1.owner.id}}],usersEdit.saving=!0,usersEdit.fail=!1,usersEdit.success=!1,API.cui.updateSecurityQuestions({personId:API.getUser(),data:{version:"1",id:API.getUser(),questions:updatedChallengeQuestions}}).then(function(res){$timeout(function(){usersEdit.saving=!1,usersEdit.success=!0},300)}).fail(function(err){$timeout(function(){usersEdit.saving=!1,usersEdit.fail=!0},300)})},usersEdit.resetChallengeQuestion=function(question){usersEdit["challengeAnswer"+question]="",selectQuestionsForUser()}}]),angular.module("app").controller("divisionCtrl",["$scope","API",function($scope,API){var newDivision=this;newDivision.userLogin={},newDivision.orgSearch={},newDivision.passwordPolicies=[{allowUpperChars:!0,allowLowerChars:!0,allowNumChars:!0,allowSpecialChars:!0,requiredNumberOfCharClasses:3},{disallowedChars:"^&*)(#$"},{min:8,max:18},{disallowedWords:["password","admin"]}],API.cui.getSecurityQuestions().then(function(res){res.splice(0,1);var numberOfQuestions=res.length,numberOfQuestionsFloor=Math.floor(numberOfQuestions/2);return newDivision.userLogin.challengeQuestions1=res.slice(0,numberOfQuestionsFloor),newDivision.userLogin.challengeQuestions2=res.slice(numberOfQuestionsFloor),newDivision.userLogin.question1=newDivision.userLogin.challengeQuestions1[0],newDivision.userLogin.question2=newDivision.userLogin.challengeQuestions2[0],API.cui.getOrganizations()}).then(function(res){newDivision.organizationList=res,$scope.$digest()}).fail(function(err){console.log(err)});var searchOrganizations=function(){newDivision.orgSearch&&API.cui.getOrganizations({qs:[["name",newDivision.orgSearch.name]]}).then(function(res){newDivision.organizationList=res,$scope.$apply()}).fail(function(err){console.log(err)})};$scope.$watchCollection("newDivision.orgSearch",searchOrganizations)}]),angular.module("app").controller("tloCtrl",["$scope","API",function($scope,API){var newTLO=this;newTLO.userLogin={};var handleError=function(err){console.log("Error\n",err)};newTLO.passwordPolicies=[{allowUpperChars:!0,allowLowerChars:!0,allowNumChars:!0,allowSpecialChars:!0,requiredNumberOfCharClasses:3},{disallowedChars:"^&*)(#$"},{min:8,max:18},{disallowedWords:["password","admin"]}],API.cui.getSecurityQuestions().then(function(res){res.splice(0,1);var numberOfQuestions=res.length,numberOfQuestionsFloor=Math.floor(numberOfQuestions/2);newTLO.userLogin.challengeQuestions1=res.slice(0,numberOfQuestionsFloor),newTLO.userLogin.challengeQuestions2=res.slice(numberOfQuestionsFloor),newTLO.userLogin.question1=newTLO.userLogin.challengeQuestions1[0],newTLO.userLogin.question2=newTLO.userLogin.challengeQuestions2[0]}).fail(handleError)}]),angular.module("app").controller("usersRegisterCtrl",["localStorageService","$scope","Person","$stateParams","API","$state",function(localStorageService,$scope,Person,$stateParams,API,$state){var usersRegister=this;usersRegister.loading=!0,usersRegister.userLogin={},usersRegister.registrationError=!1,usersRegister.applications={},usersRegister.applications.numberOfSelected=0,usersRegister.showCovisintInfo=!1,usersRegister.submitting=!1,usersRegister.targetOrganization={};var getUser=function(id){return API.cui.getPerson({personId:id})},getOrganization=function(id){return API.cui.getOrganization({organizationId:id})};usersRegister.passwordPolicies=[{allowUpperChars:!0,allowLowerChars:!0,allowNumChars:!0,allowSpecialChars:!0,requiredNumberOfCharClasses:3},{disallowedChars:"^&*)(#$"},{min:8,max:18},{disallowedWords:["password","admin"]}],$stateParams.id&&$stateParams.code?API.cui.getPersonInvitation({invitationId:$stateParams.id}).then(function(res){return res.invitationCode!==$stateParams.code?void console.log("Wrong invitation code."):getUser(res.invitee.id)}).then(function(res){return usersRegister.invitedUser=res,usersRegister.user=res,usersRegister.user.addresses=[],usersRegister.user.addresses[0]={streets:[]},usersRegister.user.phones=[],getOrganization(res.organization.id)}).then(function(res){return usersRegister.targetOrganization=res,API.cui.getSecurityQuestions()}).then(function(res){res.splice(0,1);var numberOfQuestions=res.length,numberOfQuestionsFloor=Math.floor(numberOfQuestions/2);usersRegister.userLogin.challengeQuestions1=res.slice(0,numberOfQuestionsFloor),usersRegister.userLogin.challengeQuestions2=res.slice(numberOfQuestionsFloor),usersRegister.userLogin.question1=usersRegister.userLogin.challengeQuestions1[0],usersRegister.userLogin.question2=usersRegister.userLogin.challengeQuestions2[0]}).then(function(){return API.cui.getOrganizationPackages({organizationId:usersRegister.targetOrganization.id})}).then(function(res){var listOfApps=[];res.forEach(function(packageGrant){var i=0;API.cui.getPackageServices({packageId:packageGrant.servicePackage.id}).then(function(res){i++,res.forEach(function(service){service.packageId=packageGrant.servicePackage.id,listOfApps.push(service)}),i===res.length&&(usersRegister.applications.list=listOfApps,$scope.$digest())})})}).fail(function(err){console.log(err)}):console.log("Invited user reg requires 2 url params: id (invitationId) and code (invitatioCode)"),usersRegister.applications.updateNumberOfSelected=function(a){null!==a?usersRegister.applications.numberOfSelected++:usersRegister.applications.numberOfSelected--},usersRegister.applications.process=function(){if(usersRegister.applications.processedSelected)var oldSelected=usersRegister.applications.processedSelected;return usersRegister.applications.processedSelected=[],angular.forEach(usersRegister.applications.selected,function(app,i){null!==app&&usersRegister.applications.processedSelected.push({packageId:app.split(",")[0],name:app.split(",")[1],acceptedTos:oldSelected&&oldSelected[i]?oldSelected[i].acceptedTos:!1})}),usersRegister.applications.processedSelected.length},usersRegister.applications.searchApplications=function(){API.cui.getPackages({qs:[["name",usersRegister.applications.search]]}).then(function(res){usersRegister.applications.list=res,$scope.$digest()}).fail(function(err){console.log(err)})},usersRegister.applications.toggleCovisintInfo=function(){usersRegister.showCovisintInfo=!usersRegister.showCovisintInfo},usersRegister.submit=function(){usersRegister.submitting=!0;var user;API.cui.updatePerson({personId:usersRegister.invitedUser.id,data:build.user()}).then(function(res){return user=res,API.cui.createPersonPassword(build.personPassword(user,usersRegister.targetOrganization))}).then(function(){return API.cui.createSecurityQuestionAccount(build.userSecurityQuestionAccount(user))}).then(function(){return API.cui.activatePerson({qs:[["personId",user.id]]})}).then(function(){return build.packagesSelected()}).then(function(res){0!==res.length&&angular.forEach(res,function(servicePackage){var i=0;API.cui.createPackageRequest(build.packageRequest(servicePackage)).then(function(res){i++,i===res.length&&(usersRegister.submitting=!1,usersRegister.success=!0,console.log("User Created"),$state.go("misc.success"))}).fail(function(err){console.log(err)})})}).fail(function(err){console.log(err)})};var build={user:function(){return usersRegister.user.addresses[0].country=usersRegister.userCountry.title,usersRegister.user.organization={id:usersRegister.targetOrganization.id,realm:usersRegister.targetOrganization.realm,type:"organization"},usersRegister.user.timezone="EST5EDT",usersRegister.user.phones[0]&&(usersRegister.user.phones[0].type="main"),usersRegister.user.language=$scope.$parent.base.getLanguageCode(),usersRegister.user},personPassword:function(user,org){return{personId:user.id,data:{id:user.id,version:"1",username:usersRegister.userLogin.username,password:usersRegister.userLogin.password,passwordPolicy:org.passwordPolicy,authenticationPolicy:org.authenticationPolicy}}},userSecurityQuestions:function(user){return[{question:{id:usersRegister.userLogin.question1.id,type:"question",realm:user.realm},answer:usersRegister.userLogin.challengeAnswer1,index:1},{question:{id:usersRegister.userLogin.question2.id,type:"question",realm:user.realm},answer:usersRegister.userLogin.challengeAnswer2,index:2}]},userSecurityQuestionAccount:function(user){return{personId:user.id,data:{version:"1",id:user.id,questions:this.userSecurityQuestions(user)}}},packagesSelected:function(){var packages=[];return angular.forEach(usersRegister.applications.selected,function(servicePackage){packages.push({packageId:servicePackage.split(",")[0]})}),packages},packageRequest:function(packageId){return{data:{requestor:{id:usersRegister.user.id,type:"person"},servicePackage:{id:packageId.packageId,type:"servicePackage"},reason:"Invited User Registration"}}}}}]),angular.module("app").controller("usersWalkupCtrl",["localStorageService","$scope","Person","$stateParams","API","LocaleService","$state",function(localStorageService,$scope,Person,$stateParams,API,LocaleService,$state){function handleError(err){console.log("Error!\n"),console.log(err)}var usersWalkup=this;usersWalkup.userLogin={},usersWalkup.applications={},usersWalkup.registering=!1,usersWalkup.registrationError=!1,usersWalkup.applications.numberOfSelected=0,localStorageService.get("usersWalkup.user")?usersWalkup.user=localStorageService.get("usersWalkup.user"):(usersWalkup.user={addresses:[]},usersWalkup.user.addresses[0]={streets:[]},usersWalkup.user.phones=[]),$scope.$watch("usersWalkup.user",function(a){a&&0!==Object.keys(a).length&&localStorageService.set("usersWalkup.user",a)},!0),API.cui.getSecurityQuestions().then(function(res){res.splice(0,1);var numberOfQuestions=res.length,numberOfQuestionsFloor=Math.floor(numberOfQuestions/2);return usersWalkup.userLogin.challengeQuestions1=res.slice(0,numberOfQuestionsFloor),usersWalkup.userLogin.challengeQuestions2=res.slice(numberOfQuestionsFloor),usersWalkup.userLogin.question1=usersWalkup.userLogin.challengeQuestions1[0],usersWalkup.userLogin.question2=usersWalkup.userLogin.challengeQuestions2[0],API.cui.getOrganizations()}).then(function(res){usersWalkup.organizationList=res}).fail(handleError);var searchOrganizations=function(newOrgToSearch){newOrgToSearch&&API.cui.getOrganizations({qs:[["name",newOrgToSearch.name]]}).then(function(res){usersWalkup.organizationList=res,$scope.$apply()}).fail(handleError)};$scope.$watchCollection("usersWalkup.orgSearch",searchOrganizations),$scope.$watch("usersWalkup.organization",function(newOrgSelected){newOrgSelected&&(usersWalkup.applications.numberOfSelected=0,usersWalkup.applications.processedSelected=void 0,API.cui.getOrganizationPackages({organizationId:newOrgSelected.id}).then(function(grants){usersWalkup.applications.list=[],0===grantsg.length&&(usersWalkup.applications.list=void 0,$scope.$digest()),grants.forEach(function(grant){API.cui.getPackageServices({packageId:grant.servicePackage.id}).then(function(res){usersWalkup.applications.list.push(res),i++,i===grants.length&&$scope.$digest()})})}).fail(handleError))}),usersWalkup.applications.updateNumberOfSelected=function(checkboxValue){null!==checkboxValue?usersWalkup.applications.numberOfSelected++:usersWalkup.applications.numberOfSelected--},usersWalkup.applications.process=function(){if(usersWalkup.applications.processedSelected)var oldSelected=usersWalkup.applications.processedSelected;return usersWalkup.applications.processedSelected=[],angular.forEach(usersWalkup.applications.selected,function(app,i){null!==app&&usersWalkup.applications.processedSelected.push({id:app.split(",")[0],name:app.split(",")[1],acceptedTos:oldSelected&&oldSelected[i]?oldSelected[i].acceptedTos:!1})}),usersWalkup.applications.processedSelected.length},usersWalkup.applications.searchApplications=function(){API.cui.getPackages({qs:[["name",usersWalkup.applications.search],["owningOrganization.id",usersWalkup.organization.id]]}).then(function(res){usersWalkup.applications.list=res,$scope.$apply()}).fail(handleError)},usersWalkup.submit=function(){usersWalkup.submitting=!0;var user,org;API.cui.createPerson({data:build.user()}).then(function(res){return user=res,API.cui.getOrganization({organizationId:user.organization.id})}).then(function(res){return org=res,API.cui.createSecurityQuestionAccount(build.userSecurityQuestionAccount(user))}).then(function(){return API.cui.createPersonPassword(build.personPassword(user,org))}).then(function(){return API.cui.createPersonRequest(build.personRequest(user,org))}).then(function(){usersWalkup.submitting=!1,usersWalkup.success=!0,console.log("userCreated."),$state.go("misc.success")}).fail(function(err){usersWalkup.success=!1,handleError(err)})};var build={personRequest:function(user,org){return{data:{id:user.id,registrant:{id:user.id,type:"person",realm:org.realm},justification:"User walkup registration.",servicePackageRequest:this.packageRequests()}}},packageRequests:function(){var packages={packageId:usersWalkup.applications.selected[0].split(",")[0]};return packages},personPassword:function(user,org){return{personId:user.id,data:{version:"1",username:usersWalkup.userLogin.username,password:usersWalkup.userLogin.password,passwordPolicy:org.passwordPolicy,authenticationPolicy:org.authenticationPolicy}}},userSecurityQuestionAccount:function(user){return{personId:user.id,data:{version:"1",id:user.id,questions:this.userSecurityQuestions(user)}}},user:function(){return usersWalkup.user.addresses[0].country=usersWalkup.userCountry.title,usersWalkup.user.organization={id:usersWalkup.organization.id},usersWalkup.user.timezone="EST5EDT",usersWalkup.user.phones[0]&&(usersWalkup.user.phones[0].type="main"),usersWalkup.user.language=$scope.$parent.base.getLanguageCode(),usersWalkup.user},userSecurityQuestions:function(user){return[{question:{id:usersWalkup.userLogin.question1.id,type:"question",realm:user.realm},answer:usersWalkup.userLogin.challengeAnswer1,index:1},{question:{id:usersWalkup.userLogin.question2.id,type:"question",realm:user.realm},answer:usersWalkup.userLogin.challengeAnswer2,index:2}]}}}])}(angular);